<html>
<head>
<title>BitmapUtils.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #000080; font-weight: bold;}
.s1 { color: #000000;}
.s2 { color: #808080; font-style: italic;}
.s3 { color: #0000ff;}
.s4 { color: #008000; font-weight: bold;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
BitmapUtils.java</font>
</center></td></tr></table>
<pre><span class="s0">package </span>com.example.myapplication;

<span class="s0">import </span>android.graphics.Bitmap;
<span class="s0">import </span>android.graphics.BitmapFactory;
<span class="s0">import </span>android.graphics.ImageFormat;
<span class="s0">import </span>android.graphics.Matrix;
<span class="s0">import </span>android.graphics.Rect;
<span class="s0">import </span>android.graphics.YuvImage;
<span class="s0">import </span>android.hardware.Camera.CameraInfo;

<span class="s0">import </span>android.util.Log;

<span class="s0">import </span>androidx.annotation.Nullable;

<span class="s0">import </span>com.google.firebase.ml.vision.common.FirebaseVisionImageMetadata;
<span class="s0">import </span>java.io.ByteArrayOutputStream;
<span class="s0">import </span>java.nio.ByteBuffer;

<span class="s2">/** Utils functions for bitmap conversions. */</span>
<span class="s0">public class </span>BitmapUtils {

    <span class="s2">// Convert NV21 format byte buffer to bitmap.</span>
    @Nullable
    <span class="s0">public static </span>Bitmap getBitmap(ByteBuffer data, FrameMetadata metadata) {
        data.rewind();
        <span class="s0">byte</span>[] imageInBuffer = <span class="s0">new byte</span>[data.limit()];
        data.get(imageInBuffer, <span class="s3">0</span>, imageInBuffer.length);
        <span class="s0">try </span>{
            YuvImage image =
                    <span class="s0">new </span>YuvImage(
                            imageInBuffer, ImageFormat.NV21, metadata.getWidth(), metadata.getHeight(), <span class="s0">null</span>);
            <span class="s0">if </span>(image != <span class="s0">null</span>) {
                ByteArrayOutputStream stream = <span class="s0">new </span>ByteArrayOutputStream();
                image.compressToJpeg(<span class="s0">new </span>Rect(<span class="s3">0</span>, <span class="s3">0</span>, metadata.getWidth(), metadata.getHeight()), <span class="s3">100</span>, stream);

                Bitmap bmp = BitmapFactory.decodeByteArray(stream.toByteArray(), <span class="s3">0</span>, stream.size());

                stream.close();
                <span class="s0">return </span>rotateBitmap(bmp, metadata.getRotation(), metadata.getCameraFacing());
            }
        } <span class="s0">catch </span>(Exception e) {
            Log.e(<span class="s4">&quot;VisionProcessorBase&quot;</span>, <span class="s4">&quot;Error: &quot; </span>+ e.getMessage());
        }
        <span class="s0">return null</span>;
    }

    <span class="s2">// Rotates a bitmap if it is converted from a bytebuffer.</span>
    <span class="s0">private static </span>Bitmap rotateBitmap(Bitmap bitmap, <span class="s0">int </span>rotation, <span class="s0">int </span>facing) {
        Matrix matrix = <span class="s0">new </span>Matrix();
        <span class="s0">int </span>rotationDegree = <span class="s3">0</span>;
        <span class="s0">switch </span>(rotation) {
            <span class="s0">case </span>FirebaseVisionImageMetadata.ROTATION_90:
                rotationDegree = <span class="s3">90</span>;
                <span class="s0">break</span>;
            <span class="s0">case </span>FirebaseVisionImageMetadata.ROTATION_180:
                rotationDegree = <span class="s3">180</span>;
                <span class="s0">break</span>;
            <span class="s0">case </span>FirebaseVisionImageMetadata.ROTATION_270:
                rotationDegree = <span class="s3">270</span>;
                <span class="s0">break</span>;
            <span class="s0">default</span>:
                <span class="s0">break</span>;
        }

        <span class="s2">// Rotate the image back to straight.}</span>
        matrix.postRotate(rotationDegree);
        <span class="s0">if </span>(facing == CameraInfo.CAMERA_FACING_BACK) {
            <span class="s0">return </span>Bitmap.createBitmap(bitmap, <span class="s3">0</span>, <span class="s3">0</span>, bitmap.getWidth(), bitmap.getHeight(), matrix, <span class="s0">true</span>);
        } <span class="s0">else </span>{
            <span class="s2">// Mirror the image along X axis for front-facing camera image.</span>
            matrix.postScale(-<span class="s3">1.0f</span>, <span class="s3">1.0f</span>);
            <span class="s0">return </span>Bitmap.createBitmap(bitmap, <span class="s3">0</span>, <span class="s3">0</span>, bitmap.getWidth(), bitmap.getHeight(), matrix, <span class="s0">true</span>);
        }
    }
}</pre>
</body>
</html>